<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Ark Grid Calculator — Lost Ark Edition</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root {
    /* Core Palette */
    --bg-dark: #0f1115;
    --bg-panel: rgba(26, 30, 36, 0.95);
    --bg-input: #08090b;
    
    /* Accents */
    --la-gold: #c2a076;
    --la-gold-dim: #7d6b49;
    --la-silver: #aebcd1;
    --la-blue: #3d5e75;
    --la-red: #5e3d3d;
    --la-highlight: #ffebb8;
    
    /* Text */
    --text-main: #e1e6eb;
    --text-muted: #8a96a3;
    --text-gold: #e6cc9c;

    /* Spacing */
    --gap: 20px;
    --card-radius: 4px; /* Sharper corners for game UI */
  }

  body {
    font-family: 'Lato', sans-serif;
    margin: 0;
    padding: 24px;
    background-color: var(--bg-dark);
    /* Subtle background texture */
    background-image: 
      radial-gradient(circle at 50% 0%, #252a33 0%, #0f1115 80%);
    color: var(--text-main);
    min-height: 100vh;
  }

  /* Typography */
  h1, h2, h3, .section-title, .res-title {
    font-family: 'Cinzel', serif;
    color: var(--text-gold);
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    letter-spacing: 0.5px;
  }
  
  h1 {
    font-size: 28px;
    text-align: center;
    border-bottom: 1px solid var(--la-gold-dim);
    padding-bottom: 16px;
    margin-bottom: 24px;
    background: linear-gradient(to right, transparent, rgba(194, 160, 118, 0.1), transparent);
  }

  p.note {
    text-align: center;
    color: var(--text-muted);
    font-size: 14px;
    font-style: italic;
    margin-bottom: 24px;
  }

  /* Layout */
  .page {
    display: flex;
    gap: var(--gap);
    align-items: flex-start;
    justify-content: center;
    flex-wrap: wrap;
  }

  .half {
    flex: 1;
    min-width: 340px;
    max-width: 600px;
    padding: 20px;
    border: 1px solid #333;
    background: var(--bg-panel);
    box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.05);
    position: relative;
  }
  
  /* Decorative borders */
  .half::before {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, var(--la-gold-dim), transparent);
  }

  /* Specific tinting for Left/Right to keep functionality clear but styled */
  .left { border-top: 3px solid #8a4b4b; } /* Class - Red tint */
  .right { border-top: 3px solid #4b6b8a; } /* General - Blue tint */

  .section-title {
    font-weight: 700;
    margin: 0 0 16px 0;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .section-title::after {
    content:""; flex:1; height:1px; background: rgba(255,255,255,0.1);
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 4px;
    margin-bottom: 16px;
  }
  
  th {
    text-align: center;
    font-family: 'Cinzel', serif;
    color: var(--text-muted);
    font-size: 12px;
    text-transform: uppercase;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  td {
    padding: 4px;
    text-align: center;
    background: rgba(0,0,0,0.2);
    border: 1px solid rgba(255,255,255,0.03);
  }
  
  tr:hover td {
    background: rgba(255,255,255,0.05);
  }

  /* Inputs & Controls */
  input[type=number], select {
    background: var(--bg-input);
    border: 1px solid #333;
    color: var(--la-gold);
    padding: 6px;
    font-family: 'Lato', sans-serif;
    text-align: center;
    width: 60px;
    transition: all 0.2s;
  }
  
  select { width: auto; min-width: 120px; text-align: left; }
  
  input[type=number]:focus, select:focus {
    outline: none;
    border-color: var(--la-gold);
    box-shadow: 0 0 8px rgba(194, 160, 118, 0.2);
  }

  label {
    font-size: 14px;
    color: var(--text-muted);
    cursor: pointer;
  }
  
  .core-config {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0,0,0,0.3);
    padding: 8px 12px;
    border: 1px solid rgba(255,255,255,0.05);
    margin-bottom: 8px;
  }

  /* Buttons */
  button {
    font-family: 'Cinzel', serif;
    padding: 10px 16px;
    border: 1px solid var(--la-gold-dim);
    background: linear-gradient(180deg, #2b2620 0%, #1a1712 100%);
    color: var(--text-gold);
    cursor: pointer;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    transition: all 0.2s;
    min-width: 120px;
  }

  button:hover {
    background: linear-gradient(180deg, #3d362e 0%, #26221c 100%);
    border-color: var(--la-gold);
    color: var(--la-highlight);
    text-shadow: 0 0 5px var(--la-gold);
  }

  button.secondary {
    background: linear-gradient(180deg, #2a2e33 0%, #181a1d 100%);
    border-color: #4a525c;
    color: var(--la-silver);
  }
  button.secondary:hover {
    border-color: var(--text-main);
    color: #fff;
  }

  .controls-row {
    display: flex;
    gap: 10px;
    margin-top: 16px;
    flex-wrap: wrap;
    padding-top: 12px;
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  
  .small { font-size: 12px; color: var(--text-muted); margin-top: 8px; display: block; }

  /* Results Area */
  #resultsArea {
    margin-top: 32px;
    display: flex;
    gap: var(--gap);
    justify-content: center;
    flex-wrap: wrap;
  }

  .results-half {
    flex: 1;
    min-width: 340px;
    max-width: 600px;
    background: var(--bg-panel);
    border: 1px solid #333;
    padding: 20px;
    position: relative;
  }
  
  /* Core Box Design (The Result Cards) */
  .core-box {
    margin-bottom: 16px;
    padding: 12px;
    border: 1px solid #2a2e33;
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.2));
    position: relative;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
  }
  
  /* Connector Line visual */
  .core-box::before {
    content:""; position:absolute; left:-4px; top:10px; bottom:10px; width:2px;
    background: var(--la-gold-dim); opacity:0.5;
  }

  .core-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    padding-bottom: 6px;
  }
  
  .core-header strong {
    color: var(--la-highlight);
    font-family: 'Cinzel', serif;
  }

  .gem-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
    background: rgba(0,0,0,0.3);
    padding: 10px;
    border-radius: 4px;
    border: 1px solid rgba(0,0,0,0.5);
  }

  /* Gem Visuals - The "Inventory Item" look */
  .gem-card {
    display: flex;
    flex-direction: column;
    gap: 4px;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 70px;
    padding: 4px;
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff;
    font-weight: 700;
    font-size: 14px;
    position: relative;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.8), 0 2px 4px rgba(0,0,0,0.4);
    text-shadow: 0 1px 2px #000;
  }
  
  /* Rarity/Type Colors - Enhanced */
  .gem-A { background: radial-gradient(circle at 30% 30%, #ff7a7a, #8a2b2b); border-color: #ff9999; }
  .gem-B { background: radial-gradient(circle at 30% 30%, #ffa64d, #8f5316); border-color: #ffbf80; }
  .gem-C { background: radial-gradient(circle at 30% 30%, #ffd54d, #94720d); border-color: #ffe680; }
  .gem-D { background: radial-gradient(circle at 30% 30%, #7ad17a, #246624); border-color: #99ff99; }
  .gem-E { background: radial-gradient(circle at 30% 30%, #6fc1ff, #1a5c8f); border-color: #99d6ff; }
  .gem-F { background: radial-gradient(circle at 30% 30%, #c38bff, #5e2e91); border-color: #d9b3ff; }
  .gem-G { background: radial-gradient(circle at 30% 30%, #e0e0e0, #5c5c5c); border-color: #fff; }

  .gem-type { font-size: 18px; font-family: 'Cinzel', serif; }
  .gem-sub { font-size: 10px; font-weight: 400; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }

  .metric-row {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-top: 10px;
    justify-content: flex-end;
  }
  
  .metric {
    background: #15181c;
    padding: 4px 8px;
    border: 1px solid #333;
    font-size: 12px;
    color: var(--la-silver);
  }
  
  /* Remaining Badges */
  .badge {
    background: #000;
    color: var(--text-muted);
    padding: 4px 8px;
    border: 1px solid #333;
    font-size: 11px;
    display: inline-block;
  }
  .remaining-badges { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px; }

  /* Responsive */
  @media (max-width: 900px) {
    .page, #resultsArea { flex-direction: column; align-items: stretch; }
    .half, .results-half { max-width: none; }
  }
</style>
</head>
<body>

<h1>Ark Grid Calculator</h1>
<p class="note">Manage your nodes. Optimize your Ark Passive.</p>

<div class="page">
  <div class="half left">
    <h2 class="section-title">Class Inventory</h2>
    <table aria-label="Class inventory">
      <thead><tr><th>Gem</th><th>Will</th><th>Pts</th><th>Qty</th></tr></thead>
      <tbody>
        <tr><td><span style="color:#ff7a7a">A</span></td><td>3</td><td>5</td><td><input id="class_A" type="number" min="0" value="3"></td></tr>
        <tr><td><span style="color:#ffa64d">B</span></td><td>4</td><td>5</td><td><input id="class_B" type="number" min="0" value="6"></td></tr>
        <tr><td><span style="color:#ffd54d">C</span></td><td>5</td><td>5</td><td><input id="class_C" type="number" min="0" value="3"></td></tr>
        <tr><td><span style="color:#7ad17a">D</span></td><td>3</td><td>4</td><td><input id="class_D" type="number" min="0" value="2"></td></tr>
        <tr><td><span style="color:#6fc1ff">E</span></td><td>4</td><td>4</td><td><input id="class_E" type="number" min="0" value="2"></td></tr>
        <tr><td><span style="color:#c38bff">F</span></td><td>5</td><td>4</td><td><input id="class_F" type="number" min="0" value="1"></td></tr>
        <tr><td><span style="color:#ddd">G</span></td><td>6</td><td>5</td><td><input id="class_G" type="number" min="0" value="6"></td></tr>
      </tbody>
    </table>

    <div style="margin-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:8px;">
      <label><input id="classAuto" type="checkbox" checked> Auto Target (20pts priority)</label>
    </div>

    <div id="class_core_config"></div>

    <div class="controls-row">
      <button onclick="calculateClass()">Calculate</button>
      <button class="secondary" onclick="saveInventory()">Save State</button>
      <button class="secondary" onclick="loadInventory()">Load State</button>
    </div>
  </div>

  <div class="half right">
    <h2 class="section-title">General Inventory</h2>
    <table aria-label="General inventory">
      <thead><tr><th>Gem</th><th>Will</th><th>Pts</th><th>Qty</th></tr></thead>
      <tbody>
        <tr><td><span style="color:#ff7a7a">A</span></td><td>3</td><td>5</td><td><input id="general_A" type="number" min="0" value="2"></td></tr>
        <tr><td><span style="color:#ffa64d">B</span></td><td>4</td><td>5</td><td><input id="general_B" type="number" min="0" value="2"></td></tr>
        <tr><td><span style="color:#ffd54d">C</span></td><td>5</td><td>5</td><td><input id="general_C" type="number" min="0" value="3"></td></tr>
        <tr><td><span style="color:#7ad17a">D</span></td><td>3</td><td>4</td><td><input id="general_D" type="number" min="0" value="3"></td></tr>
        <tr><td><span style="color:#6fc1ff">E</span></td><td>4</td><td>4</td><td><input id="general_E" type="number" min="0" value="2"></td></tr>
        <tr><td><span style="color:#c38bff">F</span></td><td>5</td><td>4</td><td><input id="general_F" type="number" min="0" value="1"></td></tr>
        <tr><td><span style="color:#ddd">G</span></td><td>6</td><td>5</td><td><input id="general_G" type="number" min="0" value="0"></td></tr>
      </tbody>
    </table>

    <div style="margin-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:8px;">
      <label><input id="generalAuto" type="checkbox" checked> Auto Target (20pts priority)</label>
    </div>

    <div id="general_core_config"></div>

    <div class="controls-row">
      <button onclick="calculateGeneral()">Calculate</button>
      <button class="secondary" onclick="resetDefaults()">Reset Ex.</button>
      <button onclick="calculateBoth()" style="background:linear-gradient(180deg, #5e3d3d 0%, #3a1f1f 100%); border-color:#8a4b4b;">Calc Both</button>
    </div>
  </div>
</div>

<div id="resultsArea">
  <div class="results-half" id="classResults">
    <h3 class="res-title">Class Optimization</h3>
    <div id="classResultsInner" class="small">Pending calculation...</div>
  </div>

  <div class="results-half" id="generalResults">
    <h3 class="res-title">General Optimization</h3>
    <div id="generalResultsInner" class="small">Pending calculation...</div>
  </div>
</div>

<script>
/* -------------------------
   Constants & Option A weights
   ------------------------- */
const ASTROGEMS = {
  A: { will: 3, points: 5 },
  B: { will: 4, points: 5 },
  C: { will: 5, points: 5 },
  D: { will: 3, points: 4 },
  E: { will: 4, points: 4 },
  F: { will: 5, points: 4 },
  G: { will: 6, points: 5 }
};
const CORE_WILL = { Relic: 15, Ancient: 17 };
const MAX_SLOTS = 4;
const MAX_CORES = 3;
const GEM_WEIGHT = { A: 6, B: 5, C: 4, D: 3, E: 2, F: 1, G: 0 };
const TOP_N = 200;

/* -------------------------
   UI builders
   ------------------------- */
function buildCoreConfig(containerId, prefix){
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  for(let i=1;i<=3;i++){
    const div = document.createElement('div');
    div.className = 'core-config';
    div.id = `${prefix}_corecfg_${i}`;
    div.innerHTML = `
      <label>Core ${i} Type:
        <select id="${prefix}_core${i}_rarity" style="color:${i===1?'#d48f45':'#e0e0e0'}">
          <option value="Relic">Relic (15 WP)</option>
          <option value="Ancient">Ancient (17 WP)</option>
        </select>
      </label>
      <label class="target-wrap" id="${prefix}_core${i}_target_wrap">Target:
        <select id="${prefix}_core${i}_target">
          ${Array.from({length:11}, (_,k)=>10+k).map(v=>`<option value="${v}">${v}</option>`).join('')}
        </select>
      </label>
    `;
    container.appendChild(div);
  }

  // attach auto toggle behavior for this prefix
  const autoCheckbox = document.getElementById(prefix === 'class' ? 'classAuto' : 'generalAuto');
  function updateVisibility(){
    const hide = autoCheckbox.checked;
    for(let i=1;i<=3;i++){
      const wrap = document.getElementById(`${prefix}_core${i}_target_wrap`);
      if(hide) wrap.style.display = 'none'; else wrap.style.display = 'inline-block';
    }
  }
  autoCheckbox.addEventListener('change', updateVisibility);
  updateVisibility();
}

/* -------------------------
   Inventory helpers
   ------------------------- */
function readInventory(prefix){
  const inv = {};
  for(const t of Object.keys(ASTROGEMS)){
    const el = document.getElementById(`${prefix}_${t}`);
    inv[t] = Math.max(0, parseInt(el.value || '0'));
  }
  return inv;
}
function saveInventory(){
  const data = { class: readInventory('class'), general: readInventory('general') };
  localStorage.setItem('arkGridInventory_v3', JSON.stringify(data));
  alert('State saved.');
}
function loadInventory(){
  const raw = localStorage.getItem('arkGridInventory_v3');
  if(!raw){ alert('No saved state found.'); return; }
  try{
    const obj = JSON.parse(raw);
    for(const t of Object.keys(ASTROGEMS)){
      if(obj.class && obj.class[t] !== undefined) document.getElementById(`class_${t}`).value = obj.class[t];
      if(obj.general && obj.general[t] !== undefined) document.getElementById(`general_${t}`).value = obj.general[t];
    }
    alert('State loaded.');
  }catch(e){ alert('Failed to load.'); }
}
function resetDefaults(){
  // same example as before
  document.getElementById('class_A').value = 3;
  document.getElementById('class_B').value = 6;
  document.getElementById('class_C').value = 3;
  document.getElementById('class_D').value = 2;
  document.getElementById('class_E').value = 2;
  document.getElementById('class_F').value = 1;
  document.getElementById('class_G').value = 6;

  document.getElementById('general_A').value = 2;
  document.getElementById('general_B').value = 2;
  document.getElementById('general_C').value = 3;
  document.getElementById('general_D').value = 3;
  document.getElementById('general_E').value = 2;
  document.getElementById('general_F').value = 1;
  document.getElementById('general_G').value = 0;
}

/* -------------------------
   Core combination generator (same logic as before)
   ------------------------- */
function generateCoreCombos(inv, maxWill) {
  const types = Object.keys(ASTROGEMS);
  const results = [];
  function backtrack(start, combo, counts){
    if(combo.length>0){
      let will=0, points=0;
      for(const t of combo){ will+=ASTROGEMS[t].will; points+=ASTROGEMS[t].points; }
      if(will<=maxWill){
        let pref=0; for(const t of combo) pref += (GEM_WEIGHT[t]||0);
        results.push({ combo: combo.slice(), counts: {...counts}, will, points, prefScore: pref });
      }
    }
    if(combo.length===MAX_SLOTS) return;
    for(let i=start;i<types.length;i++){
      const t = types[i];
      const used = counts[t]||0;
      if(used < (inv[t]||0)){
        combo.push(t);
        counts[t] = used+1;
        backtrack(i, combo, counts);
        combo.pop();
        if(used===0) delete counts[t]; else counts[t]=used;
      }
    }
  }
  backtrack(0, [], {});
  results.sort((a,b)=> {
    if(b.points !== a.points) return b.points - a.points;
    if(b.prefScore !== a.prefScore) return b.prefScore - a.prefScore;
    return a.will - b.will;
  });
  return results;
}

/* -------------------------
   Global optimizer for three cores (trimmed TOP_N)
   ------------------------- */
function optimizeThreeCores(inv, coreConfigs, isAuto){
  const perCoreMaxWill = coreConfigs.map(c=> CORE_WILL[c.rarity]);
  const perCoreTarget = coreConfigs.map(c=> c.target || 20);

  const combosPerCore = [];
  for(let i=0;i<3;i++){ combosPerCore.push(generateCoreCombos(inv, perCoreMaxWill[i])); }

  if(combosPerCore.some(list => list.length===0)) return { best: null, reason:'no-combos' };

  const trimmed = combosPerCore.map(list => list.slice(0, TOP_N));

  let best = null;

  function fitsInventory(trioCounts, inventory){
    for(const t of Object.keys(ASTROGEMS)){
      if((trioCounts[t]||0) > (inventory[t]||0)) return false;
    }
    return true;
  }

  const caps = perCoreTarget.map(x=> Math.min(x||20, 20));

  const list0 = trimmed[0], list1 = trimmed[1], list2 = trimmed[2];
  for(let i0=0;i0<list0.length;i0++){
    const c0 = list0[i0];
    for(let i1=0;i1<list1.length;i1++){
      const c1 = list1[i1];
      // quick partial counts
      const partial = {};
      for(const t of Object.keys(c0.counts||{})) partial[t] = (partial[t]||0) + c0.counts[t];
      for(const t of Object.keys(c1.counts||{})) partial[t] = (partial[t]||0) + c1.counts[t];
      let ok01 = true;
      for(const t of Object.keys(partial)) if(partial[t] > (inv[t]||0)){ ok01=false; break; }
      if(!ok01) continue;

      for(let i2=0;i2<list2.length;i2++){
        const c2 = list2[i2];
        const combined = {...partial};
        for(const t of Object.keys(c2.counts||{})) combined[t] = (combined[t]||0) + c2.counts[t];
        if(!fitsInventory(combined, inv)) continue;

        const pts0 = Math.min(c0.points, caps[0]);
        const pts1 = Math.min(c1.points, caps[1]);
        const pts2 = Math.min(c2.points, caps[2]);
        const totalPts = pts0 + pts1 + pts2;
        const pref = (c0.prefScore||0) + (c1.prefScore||0) + (c2.prefScore||0);
        const totalWill = (c0.will||0) + (c1.will||0) + (c2.will||0);

        // Key: maximize pts0, pts1, pts2, totalPts, pref; minimize will
        const key = [-pts0, -pts1, -pts2, -totalPts, -pref, totalWill];

        const candidate = { combos:[c0,c1,c2], counts: combined, ptsRaw:[c0.points,c1.points,c2.points], will:[c0.will,c1.will,c2.will], key };

        if(!best) { best = candidate; continue; }
        // lex compare
        let better = false, worse=false;
        for(let k=0;k<key.length;k++){
          if(key[k] < best.key[k]) { better = true; break; }
          if(key[k] > best.key[k]) { worse = true; break; }
        }
        if(better) best = candidate;
      }
    }
  }
  return { best };
}

/* -------------------------
   Read core configs (per half) and handle Auto toggle
   ------------------------- */
function readCoreConfigs(prefix){
  const arr=[];
  const isAuto = document.getElementById(prefix === 'class' ? 'classAuto' : 'generalAuto').checked;
  for(let i=1;i<=3;i++){
    const rarity = document.getElementById(`${prefix}_core${i}_rarity`).value;
    const target = isAuto ? 20 : parseInt(document.getElementById(`${prefix}_core${i}_target`).value);
    arr.push({ rarity, target });
  }
  return arr;
}

/* -------------------------
   Format helpers for results: gem-card representation
   ------------------------- */
function buildGemCards(combo){
  // combo is array of letters
  return combo.map(t => {
    const c = t.toUpperCase();
    const info = ASTROGEMS[c];
    return `<div class="gem-card gem-${c}"><div class="gem-type">${c}</div><div class="gem-sub">${info.points}★ ${info.will}W</div></div>`;
  }).join('');
}

/* -------------------------
   Compute remaining
   ------------------------- */
function computeRemaining(inv, used){
  const rem = {};
  for(const t of Object.keys(ASTROGEMS)) rem[t] = (inv[t]||0) - (used[t]||0);
  return rem;
}

/* -------------------------
   Display results for one half
   ------------------------- */
function renderResults(containerId, resultObj, inv){
  const container = document.getElementById(containerId);
  if(!resultObj || !resultObj.best){ container.innerHTML = `<div class="small">No valid combos found for this configuration.</div>`; return; }
  const best = resultObj.best;
  let html = '';
  for(let i=0;i<3;i++){
    const c = best.combos[i];
    html += `<div class="core-box">
      <div class="core-header"><div><strong>Core ${i+1}</strong> <span style="font-size:12px;color:#aaa">(${c.counts ? Object.values(c.counts).reduce((a,b)=>a+b,0) : c.combo.length} gems)</span></div>
      <div class="small" style="color:#fff">WP: ${c.will} &nbsp;•&nbsp; Pts: ${c.points}</div></div>
      <div class="gem-row">${buildGemCards(c.combo)}</div>
    </div>`;
  }
  // remaining badges
  const remaining = computeRemaining(inv, best.counts);
  const badges = Object.keys(remaining).filter(k=>remaining[k]>0).map(k => `<div class="badge">${k}: ${remaining[k]}</div>`).join('');
  html += `<div style="padding:0 4px;margin-top:12px"><strong style="font-size:12px;color:#8a96a3;text-transform:uppercase;">Unused Gems</strong><div class="remaining-badges">${badges || '<span class="small">None</span>'}</div></div>`;
  container.innerHTML = html;
}

/* -------------------------
   Public calculate functions
   ------------------------- */
function calculateClass(){
  const inv = readInventory('class');
  const cfg = readCoreConfigs('class');
  const auto = document.getElementById('classAuto').checked;
  const res = optimizeThreeCores(inv, cfg, auto);
  renderResults('classResultsInner', res, inv);
}

function calculateGeneral(){
  const inv = readInventory('general');
  const cfg = readCoreConfigs('general');
  const auto = document.getElementById('generalAuto').checked;
  const res = optimizeThreeCores(inv, cfg, auto);
  renderResults('generalResultsInner', res, inv);
}

function calculateBoth(){
  calculateClass();
  calculateGeneral();
}

/* -------------------------
   Initialize
   ------------------------- */
window.onload = function(){
  buildCoreConfig('class_core_config','class');
  buildCoreConfig('general_core_config','general');
  // default hide/show handled in buildCoreConfig
  // initial calculation
  setTimeout(calculateBoth, 100);
};
</script>
</body>
</html>